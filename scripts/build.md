# Factorio Mod Build and Release Script

A comprehensive Python script that automates the complete build and release process for Factorio mods.

## WARN: generated by AI (Claude sonnet 4.5) with poor review, use with extreme caution

## Features

✅ **Version Validation**
- Extracts and compares versions from `info.json` and `changelog.txt`
- Ensures version format is `vX.Y.Z`
- Validates previous version from changelog

✅ **Build Process**
- Creates mod package (ZIP) in `projectdir/../`
- Creates 7z backup archive in `projectdir/../`
- Excludes `.git/`, `scripts/`, `tmp/`, and backup files

✅ **Testing & Deployment**
- Optionally runs Factorio for testing
- Optionally cleans project directory (keeps `.git/`)
- Creates and pushes git tag
- Creates GitHub release with changelog

✅ **Safety Features**
- Multiple validation checks
- Confirmation before release
- Detailed error messages
- Comprehensive logging

## Directory Structure

```
parent/
├── projectdir/
│   ├── .git/
│   ├── scripts/
│   │   └── build_and_release.py  ← This script
│   ├── tmp/                       ← Temporary files (created if needed)
│   ├── info.json
│   ├── changelog.txt
│   └── (other mod files)
├── ModName_X.Y.Z.zip             ← Output package
└── ModName_vX.Y.Z_backup.7z      ← Backup archive
```

## Prerequisites

### Required Tools

1. **Python 3.6+**
2. **Git**
3. **GitHub CLI (gh)**
   ```bash
   # Ubuntu/Debian
   sudo apt install gh
   
   # Or download from https://cli.github.com/
   ```
4. **7-Zip**
   ```bash
   # Ubuntu/Debian
   sudo apt install p7zip-full
   ```

### Authenticate GitHub CLI

```bash
gh auth login
```

## File Format Requirements

### info.json
```json
{
  "name": "my-mod",
  "version": "1.2.3",
  ...
}
```
Version can be with or without 'v' prefix. Script will normalize to `vX.Y.Z`.

### changelog.txt
Expected format:
```
---------------------------------------------------------------------------------------------------
Version: 1.2.3
Date: 2024-02-04
  Changes:
    - Added feature X
    - Fixed bug Y
---------------------------------------------------------------------------------------------------
Version: 1.2.2
Date: 2024-01-15
  Changes:
    - Previous version changes
---------------------------------------------------------------------------------------------------
```

The script:
- Skips first 3 lines
- Extracts content until the next `----` line
- Removes leading spaces
- Adds line breaks for readability

## Usage

### Basic Usage
```bash
cd /path/to/projectdir
python3 scripts/build_and_release.py
```

### Specify Factorio Path
```bash
python3 scripts/build_and_release.py --factorio-path /usr/games/factorio
```

### Skip Factorio Testing
```bash
python3 scripts/build_and_release.py --skip-factorio
```

### Skip Project Directory Cleanup
```bash
python3 scripts/build_and_release.py --skip-clean
```

### Combine Options
```bash
python3 scripts/build_and_release.py \
  --factorio-path ~/games/factorio/bin/x64/factorio \
  --skip-factorio \
  --skip-clean
```

## Workflow

The script executes the following steps in order:

1. **Version Validation**
   - Reads `info.json` and extracts version and mod name
   - Reads `changelog.txt` and extracts current and previous versions
   - Validates both versions match
   - Validates version format is `vX.Y.Z`
   - Validates previous version format (if exists)

2. **Build Package**
   - Creates `ModName_X.Y.Z.zip` in parent directory
   - Includes all files except:
     - `.git/` directory
     - `scripts/` directory
     - `tmp/` directory
     - `*.zip` and `*.7z` files
     - Backup files (`*~`)

3. **Create Backup**
   - Creates `ModName_vX.Y.Z_backup.7z` in parent directory
   - Full project backup excluding `.git/` and archives

4. **Clean Project Directory** (optional)
   - Removes all files and directories
   - Preserves `.git/` directory only
   - Can be skipped with `--skip-clean`

5. **Test with Factorio** (optional)
   - Launches Factorio for testing
   - Waits for user to close Factorio
   - Can be skipped with `--skip-factorio`

6. **Confirmation**
   - Displays summary of release
   - Asks for confirmation to proceed
   - User can cancel at this point

7. **Verify Previous Tag**
   - Checks that previous version tag exists in git
   - Ensures changelog history is accurate

8. **Create Git Tag**
   - Creates annotated git tag `vX.Y.Z`
   - Pushes tag to `origin`

9. **Create GitHub Release**
   - Extracts changelog for current version
   - Creates GitHub release from tag
   - Uploads ZIP package as release asset
   - Uses changelog as release notes

## Error Handling

The script will stop and show an explicit error if:

- `info.json` or `changelog.txt` is missing
- Versions don't match between files
- Version format is not `vX.Y.Z`
- Previous version format is invalid
- Git tag already exists
- Previous version tag doesn't exist
- Required tools (`gh`, `7z`) are not installed
- Factorio path is invalid

## Examples

### First Release (No Previous Version)
```
changelog.txt:
---------------------------------------------------------------------------------------------------
Version: 0.1.0
Date: 2024-02-04
  Info:
    - Initial release
---------------------------------------------------------------------------------------------------
```
Script will detect no previous version and proceed accordingly.

### Subsequent Release
```
changelog.txt:
---------------------------------------------------------------------------------------------------
Version: 1.2.3
Date: 2024-02-04
  Changes:
    - Added new feature
    - Fixed critical bug
---------------------------------------------------------------------------------------------------
Version: 1.2.2
Date: 2024-01-15
  Changes:
    - Previous version
---------------------------------------------------------------------------------------------------
```
Script will verify that tag `v1.2.2` exists before creating `v1.2.3`.

## Troubleshooting

### "GitHub CLI (gh) not found"
Install GitHub CLI and authenticate:
```bash
sudo apt install gh
gh auth login
```

### "Neither 7z nor 7za found"
Install p7zip:
```bash
sudo apt install p7zip-full
```

### "Git tag already exists"
If you need to re-release, delete the tag:
```bash
git tag -d vX.Y.Z
git push origin :refs/tags/vX.Y.Z
```

### "Previous tag not found"
Ensure your changelog's previous version matches an actual git tag:
```bash
git tag -l
```

## Development

### Making the Script Executable
```bash
chmod +x scripts/build_and_release.py
```

### Running from Anywhere
The script automatically detects its location and finds the project directory:
```bash
cd /anywhere
python3 /path/to/projectdir/scripts/build_and_release.py
```

## Tips

1. **Test Mode**: Use `--skip-factorio --skip-clean` for faster iteration during testing
2. **Dry Run**: Run with `--skip-clean` to keep your files while testing the build
3. **Version Bumping**: Update both `info.json` and `changelog.txt` before running
4. **Backup**: The 7z backup is your safety net - keep it until release is confirmed

## License

This script is provided as-is for use with Factorio mod development.
